name: Daily Mathematical Problem Generator

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´17:10ï¼ˆUTC+8ï¼‰è¿è¡Œï¼Œå³UTCæ—¶é—´9:10
  schedule:
    - cron: '10 9 * * *'
  
  # æ¯å¤©åŒ—äº¬æ—¶é—´20ç‚¹è¿è¡Œç­”æ¡ˆç”Ÿæˆï¼Œå³UTCæ—¶é—´12ç‚¹  
  schedule:
    - cron: '0 12 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action to perform'
        required: true
        default: 'generate-problem'
        type: choice
        options:
        - generate-problem
        - generate-answer
        - both
      category:
        description: 'Problem category (optional)'
        required: false
        type: string

jobs:
  # ç”Ÿæˆæ–°é¢˜ç›®çš„ä½œä¸š
  generate-problem:
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 1 * * *' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.action_type == 'generate-problem' || github.event.inputs.action_type == 'both')) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.name "Mathematical Everyday Bot"
        git config --global user.email "mathematical-everyday@users.noreply.github.com"

    - name: Check if problem exists for today
      id: check_problem
      run: |
        TODAY=$(date +%Y-%m-%d)
        if find questions -name "*${TODAY}*" -type f | grep -q .; then
          echo "problem_exists=true" >> $GITHUB_OUTPUT
          echo "ğŸ“š Problem already exists for today: $TODAY"
        else
          echo "problem_exists=false" >> $GITHUB_OUTPUT
          echo "ğŸ¯ No problem found for today: $TODAY"
        fi

    - name: Generate daily problem
      if: steps.check_problem.outputs.problem_exists == 'false'
      run: |
        if [ "${{ github.event.inputs.category }}" != "" ]; then
          npm start generate-problem -c "${{ github.event.inputs.category }}"
        else
          npm start generate-problem
        fi
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DOUBAO_API_KEY: ${{ secrets.DOUBAO_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_MODEL: ${{ vars.AI_MODEL || 'deepseek' }}

    - name: Update README
      if: steps.check_problem.outputs.problem_exists == 'false'
      run: node update-readme.js

    - name: Commit and push changes
      if: steps.check_problem.outputs.problem_exists == 'false'
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          TODAY=$(date +%Y-%m-%d)
          git commit -m "ğŸ¯ Generate daily problem for $TODAY

          ğŸ“š Auto-generated by GitHub Actions
          ğŸ¤– Powered by AI
          ğŸ“… Date: $TODAY"
          git push
        fi

  # ç”Ÿæˆç­”æ¡ˆçš„ä½œä¸š
  generate-answer:
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 12 * * *' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.action_type == 'generate-answer' || github.event.inputs.action_type == 'both')) }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.name "Mathematical Everyday Bot"
        git config --global user.email "mathematical-everyday@users.noreply.github.com"

    - name: Generate answers for pending problems
      run: npm start generate-solutions
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        DOUBAO_API_KEY: ${{ secrets.DOUBAO_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_MODEL: ${{ vars.AI_MODEL || 'deepseek' }}

    - name: Update README
      run: node update-readme.js

    - name: Commit and push changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          TODAY=$(date +%Y-%m-%d)
          git commit -m "âœ… Generate answers for pending problems

          ğŸ“ Auto-generated solutions by GitHub Actions
          ğŸ¤– Powered by AI
          ğŸ“… Date: $TODAY"
          git push
        fi

  # ç»Ÿè®¡å’Œç»´æŠ¤ä½œä¸šï¼ˆæ¯å‘¨æ—¥è¿è¡Œï¼‰
  maintenance:
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 0 * * 0' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate statistics
      run: |
        echo "ğŸ“Š Project Statistics" > WEEKLY_STATS.md
        echo "Generated on: $(date)" >> WEEKLY_STATS.md
        echo "" >> WEEKLY_STATS.md
        npm start stats >> WEEKLY_STATS.md 2>&1 || true

    - name: Check for duplicates
      run: |
        echo "" >> WEEKLY_STATS.md
        echo "ğŸ” Duplicate Check Results" >> WEEKLY_STATS.md
        npm start check-duplicates -v >> WEEKLY_STATS.md 2>&1 || true

    - name: History cleanup
      run: |
        npm start history cleanup -n 1000 || true
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}

    - name: Update README with latest statistics
      run: node update-readme.js

    - name: Commit maintenance updates
      run: |
        git config --global user.name "Mathematical Everyday Bot"
        git config --global user.email "mathematical-everyday@users.noreply.github.com"
        git add .
        if git diff --staged --quiet; then
          echo "No maintenance changes to commit"
        else
          git commit -m "ğŸ§¹ Weekly maintenance and statistics update

          ğŸ“Š Updated project statistics
          ğŸ” Performed duplicate check
          ğŸ§¹ Cleaned up history records
          ğŸ“… Date: $(date +%Y-%m-%d)"
          git push
        fi
